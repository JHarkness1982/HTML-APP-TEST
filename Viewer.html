<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  body, html { margin:0; padding:0; height:100%; }
  #map { height:100%; width:100%; }

  #timestamp {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 14px;
    font-family: sans-serif;
    z-index: 9999;
    pointer-events: none;
  }
</style>
</head>

<body>

<div id="map"></div>
<div id="timestamp">Ultimo aggiornamento: --</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ðŸ”¥ ENDPOINT GOOGLE APPS SCRIPT */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbx9aK4oyA1Qyu9Ql4HNCV3TQP8r0OAbxn0_ZP4B6cC8oOpT0uJ4yxJph6d3MWgZBxyR/exec";

/* Mappa iniziale */
let map = L.map('map').setView([44.0, 10.0], 13);
let marker = L.marker([44.0, 10.0]).addTo(map);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

/* Variabile per centrare la mappa solo al primo aggiornamento */
let firstUpdate = true;

/* Funzione di aggiornamento */
async function update() {
  try {
    const res = await fetch(ENDPOINT);
    const data = await res.json();

    if (!data.lat || !data.lon) return;

    /* Conversione virgola â†’ punto */
    const lat = parseFloat(data.lat.toString().trim().replace(",", "."));
    const lon = parseFloat(data.lon.toString().trim().replace(",", "."));

    if (isNaN(lat) || isNaN(lon)) return;

    /* Aggiorna il marker */
    marker.setLatLng([lat, lon]);

    /* Centra la mappa SOLO al primo aggiornamento, con 2 secondi di ritardo */
    if (firstUpdate) {
      firstUpdate = false;
      setTimeout(() => {
        const currentZoom = map.getZoom();
        map.setView([lat, lon], currentZoom);
      }, 2000);
    }

    /* Timestamp */
    const d = new Date(parseInt(data.timestamp));
    const formatted = d.toLocaleString("it-IT", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });

    document.getElementById("timestamp").textContent =
      "Ultimo aggiornamento " + formatted;

  } catch (e) {
    console.log("Errore:", e);
  }
}

/* Aggiorna subito e poi ogni 3 secondi */
update();
setInterval(update, 3000);
</script>

</body>
</html>

</body>
</html>


