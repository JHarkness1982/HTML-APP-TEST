<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  body, html { margin:0; padding:0; height:100%; }
  #map { height:100%; width:100%; }

  #timestamp {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 14px;
    font-family: sans-serif;
    z-index: 9999;          /* Sempre sopra la mappa */
    pointer-events: none;   /* Non blocca zoom/pan */
  }
</style>
</head>

<body>

<div id="map"></div>
<div id="timestamp">Ultimo aggiornamento: --</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ðŸ”¥ ENDPOINT SHEETDB: restituisce SOLO lâ€™ultima riga */
const ENDPOINT = "https://sheetdb.io/api/v1/0a2wy7lgvckyt?sort_by=timestamp&sort_order=desc&limit=1";

/* Mappa iniziale */
let map = L.map('map').setView([44.0, 10.0], 13);
let marker = L.marker([44.0, 10.0]).addTo(map);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

/* Funzione di aggiornamento */
async function update() {
  try {
    const res = await fetch(ENDPOINT);
    const arr = await res.json();

    if (!arr || !arr[0]) return;

    const data = arr[0];

    if (!data.lat || !data.lon) return;

    const lat = parseFloat(data.lat);
    const lon = parseFloat(data.lon);

    marker.setLatLng([lat, lon]);
    map.setView([lat, lon]);

    /* Timestamp */
    const d = new Date(parseInt(data.timestamp));
    const formatted = d.toLocaleString("it-IT", {
      day: "2-digit",
      month: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });

    document.getElementById("timestamp").textContent =
      "Ultimo aggiornamento " + formatted;

  } catch (e) {
    console.log("Errore:", e);
  }
}

/* Aggiorna subito e poi ogni 3 secondi */
update();
setInterval(update, 3000);
</script>

</body>
</html>
